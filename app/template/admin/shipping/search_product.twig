<script>

    // 受注明細行を追加する.
    // 受注明細行のレコード数カウンタ(order_details_count)は, edit.twig側で定義している.
    function fnAddOrderDetail($row, shipment_item_id, type) {

        type = type === undefined ? {{ constant('Eccube\\Entity\\Master\\OrderItemType::PRODUCT') }} : type;

        // 受注明細行を取得.
        var list = $('#order_detail_list');
        var orderDetailExists = false;

        $('*[id^="product_info_list__item--"]').each(function () {
            var $inputs = $(this).find(':input');

            if ($inputs.filter('[id$="_ProductClass"][value="'+shipment_item_id+'"]').length > 0) {

                orderDetailExists = true;
                return false;
            }
        });

        if (!orderDetailExists) {

            // prototype templateを取得.
            var newWidget = list.attr('data-prototype');
            // レコード数カウンタで置換.
            newWidget = newWidget.replace(/__name__/g, order_details_count);
            // フォーム入力値をセットm
            $newWidget = $(newWidget);
            /* $newWidget.find('#order_ShipmentItems_' + order_details_count + '_Product').val(product_id);
             * $newWidget.find('#order_ShipmentItems_' + order_details_count + '_ProductClass').val(product_class_id);
             * $newWidget.find('#order_ShipmentItems_' + order_details_count + '_price').val(price);
             * $newWidget.find('#order_ShipmentItems_' + order_details_count + '_quantity').val(1); // コントローラ側で再取得するため、仮の値をセット
             * $newWidget.find('#order_ShipmentItems_' + order_details_count + '_tax_rate').val(8); // コントローラ側で再取得するため、仮の値をセット*/
            $newWidget.find('#order_ShipmentItems_' + order_details_count + '_shipment_item_id').val(shipment_item_id);
            $newWidget.find('#order_ShipmentItems_' + order_details_count + '_order_item_type').val(type);

            // 明細行に追加.
            list.append($newWidget);
        }

        if (orderDetailExists) {
            // カウンタを更新.
            order_details_count++;
        }

        // モーダル閉じる.
        $('#searchProductModal').modal('hide');

        // 再計算のためsubmit.
        setModeAndSubmit('modal');

        return false;
    }

    // 商品検索
    $('#product_pagination a').on('click', function(event) {
        var list = $('#searchProductModalList');
        list.children().remove();

        $.ajax({
            type: 'GET',
            dataType: 'html',
            url: $(this).attr('href'),
            success: function(data) {
                $('#searchProductModalList').html(data);
            },
            error: function() {
                alert('search product failed.');
            }
        });
        event.preventDefault();
    });
</script>
<div class="table-responsive">
    <table class="table">
        <thead>
            <tr>
                <th>注文日・注文ID</th><th>注文者</th><th>注文内容</th><th></th>
            </tr>
        </thead>
        <tbody>
            {% for ShipmentItem in pagination %}
                <form name="product_form{{ ShipmentItem.id }}">
                    {% set form = forms[ShipmentItem.id] %}

                    <tr>
                        <td>
                            {{ ShipmentItem.Order.order_date ? ShipmentItem.Order.order_date |date("Y/m/d H:i:s") : '' }}<br>注文ID: {{ ShipmentItem.Order.id }}
                        </td>
                        <td>
                            {{ ShipmentItem.Order.Name01 }} {{ ShipmentItem.Order.Name02 }} ({{ ShipmentItem.Order.Kana01 }} {{ ShipmentItem.Order.Kana02 }})<br>
                            {{ ShipmentItem.Order.Zip01 }}-{{ ShipmentItem.Order.Zip02 }}<br>
                            {{ ShipmentItem.Order.Pref }}{{ ShipmentItem.Order.Addr01 }}{{ ShipmentItem.Order.Addr02 }}<br>
                        </td>
                        <td>
                            {{ ShipmentItem.product_name }}
                            {% if ShipmentItem.product_code %}
                                <span><br/>{{ ShipmentItem.product_code }}
                            {% endif %}
                            <br />{{ ShipmentItem.price|price }}
                        </td>
                        <div class="extra-form">
                            {% for f in form.getIterator %}
                                {% if f.vars.name matches '[^plg*]' %}
                                    {{ form_label(f) }}
                                    {{ form_widget(f) }}
                                    {{ form_errors(f) }}
                                {% endif %}
                            {% endfor %}
                        </div>
                        <td class="text-right">
                            <button onclick="fnAddOrderDetail($(this).parent().parent(), {{ ShipmentItem.id }}, {{ ShipmentItem.OrderItemType.id }})" type="button" class="btn btn-default btn-sm" name="mode" value="modal">
                                決定
                            </button>
                        </td>
                    </tr>
                </form>
            {% endfor %}
        </tbody>
    </table>
    {% if pagination.totalItemCount > 0 %}
        {% include "pager.twig" with {'id': 'product_pagination', 'pages': pagination.paginationData, 'routes': 'admin_order_search_product_page'} %}
    {% endif %}
</div>
