{#
This file is part of EC-CUBE

Copyright(c) 2000-2015 LOCKON CO.,LTD. All Rights Reserved.

http://www.lockon.co.jp/

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation; either version 2
of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
#}
{% extends '@admin/styleguide_frame.twig' %}

{% set menus = ['product', 'product_master'] %}

{% block title %}商品管理{% endblock %}
{% block sub_title %}商品マスター{% endblock %}

{% form_theme searchForm '@admin/Form/bootstrap_4_horizontal_layout.html.twig' %}

{% block stylesheet %}
    <link rel="stylesheet" href="{{ asset('assets/css/bootstrap-datetimepicker.min.css', 'admin') }}">
{% endblock stylesheet %}

{% block javascript %}
    <script src="{{ asset('assets/js/vendor/moment.min.js', 'admin') }}"></script>
    <script src="{{ asset('assets/js/vendor/moment-ja.js', 'admin') }}"></script>
    <script src="{{ asset('assets/js/vendor/bootstrap-datetimepicker.min.js', 'admin') }}"></script>
    <script>
        $(function () {

            var inputDate = document.createElement('input');
            inputDate.setAttribute('type', 'date');
            if (inputDate.type !== 'date') {
                $('input[id$=_date_start]').datetimepicker({
                    locale: 'ja',
                    format: 'YYYY-MM-DD',
                    useCurrent: false,
                    showTodayButton: true
                });

                $('input[id$=_date_end]').datetimepicker({
                    locale: 'ja',
                    format: 'YYYY-MM-DD',
                    useCurrent: false,
                    showTodayButton: true
                });
            }

            // フォーム値を確認し、アコーディオンを制御
            // 値あり : 開く / 値なし : 閉じる
            (function ($, f) {
                //フォームがないページは処理キャンセル
                var $ac = $(".accpanel");
                if (!$ac) {
                    return false
                }

                //フォーム内全項目取得
                var c = f();
                if (c.formState()) {
                    if ($ac.css("display") == "none") {
                        $ac.siblings('.toggle').addClass("active");
                        $ac.slideDown(0);
                    }
                } else {
                    $ac.siblings('.toggle').removeClass("active");
                    $ac.slideUp(0);
                }
            })($, formPropStateSubscriber);
        });
    </script>
{% endblock javascript %}

{% block main %}
    <div class="c-outsideBlock">
        <form id='search_form' method="post" action="{{ url('admin_product') }}">
            {{ form_widget(searchForm._token) }}
            <div class="c-outsideBlock__contents">
                <div class="row justify-content-start">

                    <div class="col-6">
                        <div class="mb-2">
                            <label class="col-form-label">商品名・商品ID・商品コード</label>
                            {{ form_widget(searchForm.id) }}
                        </div>
                        <div class="d-inline-block mb-3" data-toggle="collapse" href="#searchDetail"
                             aria-expanded="false" aria-controls="searchDetail"><a><i
                                        class="fa fa-plus-square-o font-weight-bold mr-1"></i><span
                                        class="font-weight-bold">詳細検索</span></a></div>
                    </div>
                </div>
            </div>
            <div class="c-subContents collapse ec-collapse" id="searchDetail">
                <div class="row mb-2">
                    <div class="col-6">
                        <div class="form-row mb-2">
                            <div class="col-6">
                                <label class="col-form-label">カテゴリ</label>
                                {{ form_widget(searchForm.category_id) }}
                            </div>
                        </div>
                        <div class="form-row mb-2">
                            <div class="col-12">
                                <p class="col-form-label">フィルタ</p>
                                {# TODO: 未実装（フィルターが検索後の絞込から検索条件に併合された） #}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="check_public" type="checkbox" value="">
                                    <label class="form-check-label" for="check_public">公開</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="check_private" type="checkbox" value="">
                                    <label class="form-check-label" for="check_private"> 非公開</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" id="check_stockout" type="checkbox" value="">
                                    <label class="form-check-label" for="check_stockout"> 在庫切れ</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="mb-2">
                            <label class="col-form-label" data-toggle="tooltip" data-placement="top" title="Tooltip">
                                登録日
                                <i class="fa fa-question-circle fa-lg ml-1"></i>
                            </label>
                            <div class="form-row align-items-center">
                                <div class="col">
                                    {# TODO: カレンダー表示の調整 #}
                                    {{ form_widget(searchForm.create_date_start) }}
                                </div>
                                <div class="col-auto text-center"><span>〜</span></div>
                                <div class="col">
                                    {{ form_widget(searchForm.create_date_end) }}
                                </div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label class="col-form-label">更新日</label>
                            <div class="form-row align-items-center">
                                <div class="col">
                                    {# TODO: カレンダー表示の調整 #}
                                    {{ form_widget(searchForm.update_date_start) }}
                                </div>
                                <div class="col-auto"><span>〜</span></div>
                                <div class="col">
                                    {{ form_widget(searchForm.update_date_end) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-block text-center">
                    <button class="btn btn-ec-regular search-clear" type="button">検索条件クリア</button>
                </div>
            </div>
            <div class="c-outsideBlock__contents mb-5">
                <button class="btn btn-ec-conversion px-5" type="submit">検索</button>
                {% if pagination %}
                    <span class="font-weight-bold ml-2">検索結果：{{ pagination.totalItemCount }}件が該当しました</span>
                {% endif %}
            </div>
        </form>

    </div>
    <div class="c-contentsArea__cols">
        <div class="c-contentsArea__primaryCol">
            <div class="c-primaryCol">
                {# TODO 「商品が全く登録されていない場合の条件に変更 #}
                {% if pagination %}
                    {% if pagination|length > 0 %}
                        <div class="row justify-content-between mb-2">
                            <div class="col-6">
                                <label class="mr-2">一括操作</label>
                                {# TODO ここのボタンは新機能なので実装が必要 #}
                                <div class="btn-group mr-2" role="group">
                                    <button class="btn btn-ec-regular" type="button"><span>公開</span></button>
                                    <button class="btn btn-ec-regular" type="button"><span>非公開</span></button>
                                </div>
                                <button class="btn btn-ec-regular mr-2">廃止</button>
                                <button class="btn btn-ec-delete">完全に削除</button>
                            </div>
                            <div class="col-5 text-right">
                                <div class="d-inline-block mr-2">
                                    <div>
                                        <select class="custom-select">
                                            {# TODO リンクからセレクトボックスに変更されているので実装必要 #}
                                            {% for pageMax in pageMaxis %}
                                                <option {% if pageMax.name == page_count %}selected=""{% endif %}>{{ pageMax.name|e }}
                                                    件
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="d-inline-block">
                                    <div class="btn-group" role="group">
                                        {# TODO onclickは適切ではないのでaタグで実装できるようにする #}
                                        <button class="btn btn-ec-regular" type="button"
                                                onclick='location.href="{{ url('admin_product_export') }}"'><i
                                                    class="fa fa-cloud-download mr-1 text-secondary"></i><span>CSVダウンロード</span>
                                        </button>
                                        {# TODO onclickは適切ではないのでaタグで実装できるようにする #}
                                        <button class="btn btn-ec-regular" type="button"
                                                onclick='location.href="{{ url('admin_setting_shop_csv', { id : constant('\\Eccube\\Entity\\Master\\CsvType::CSV_TYPE_PRODUCT') }) }}"'>
                                            <i
                                                    class="fa fa-cog mr-1 text-secondary"></i><span>CSV出力設定</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card rounded border-0 mb-4">
                            <div class="card-body p-0">
                                <table class="table table-sm">
                                    <thead>
                                    <tr>
                                        <th class="border-top-0 pl-3 pt-2 pb-2">
                                            <input type="checkbox" name="filter" value="open">
                                        </th>
                                        <th class="border-top-0 pt-2 pb-2">ID</th>
                                        <th class="border-top-0 pt-2 pb-2">画像</th>
                                        <th class="border-top-0 pt-2 pb-2">商品名</th>
                                        <th class="border-top-0 pt-2 pb-2">コード</th>
                                        <th class="border-top-0 pt-2 pb-2">価格</th>
                                        <th class="border-top-0 pt-2 pb-2">在庫数</th>
                                        <th class="border-top-0 pt-2 pb-2">公開状態</th>
                                        <th class="border-top-0 pt-2 pb-2">登録日</th>
                                        <th class="border-top-0 pt-2 pb-2">更新日</th>
                                        <th class="border-top-0 pt-2 pb-2 pr-3" colspan="3"></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for Product in pagination %}
                                        <tr>
                                            <td class="align-middle pl-3">
                                                <input type="checkbox" name="filter" value="open">
                                            </td>
                                            <td class="align-middle">{{ Product.id }}</td>
                                            {# TODO: 画像のサイズをベタ指定しているので、styleguide側を直す #}
                                            <td class="align-middle">
                                                <a href="{{ url('admin_product_product_edit', { id : Product.id }) }}">
                                                    <img src="{{ asset(Product.mainFileName|no_image_product, 'save_image') }}"
                                                         style="max-width: 50px">
                                                </a>
                                            </td>
                                            <td class="align-middle"><a
                                                        href="{{ url('admin_product_product_edit', { id : Product.id }) }}">{{ Product.name }}</a>
                                            </td>
                                            <td class="align-middle">
                                                {{ Product.code_min }}
                                                {% if Product.code_min != Product.code_max %} ～ {{ Product.code_max }}
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {{ Product.price02_min|price }}
                                                {% if Product.price02_min != Product.price02_max %} ～ {{ Product.price02_max|price }}
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {% if (Product.hasProductClass) %}
                                                    {# TODO 規格のモーダル表示を実装 #}
                                                    <button class="btn page-link text-dark d-inline-block" type="button"
                                                            data-toggle="modal" data-target="#standardConfirm">規格確認
                                                    </button>
                                                    <div class="modal fade" id="standardConfirm" tabindex="-1"
                                                         role="dialog"
                                                         aria-labelledby="standardConfirm" aria-hidden="true"
                                                         style="display: none;">
                                                        <div class="modal-dialog" role="document">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title">パーコレーターの規格</h5>
                                                                    <button class="close" type="button"
                                                                            data-dismiss="modal"
                                                                            aria-label="Close"><span aria-hidden="true">×</span>
                                                                    </button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <table class="table table-striped">
                                                                        <thead class="table-active">
                                                                        <tr>
                                                                            <th class="pt-2 pb-2 pl-2">規格１</th>
                                                                            <th class="pt-2 pb-2">規格２</th>
                                                                            <th class="pt-2 pb-2">商品コード</th>
                                                                            <th class="pt-2 pb-2">在庫数</th>
                                                                            <th class="pt-2 pb-2 pr-2">販売価格（円）</th>
                                                                        </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                        <tr>
                                                                            <td class="pl-2">プラチナ</td>
                                                                            <td>100cm</td>
                                                                            <td>aa-001</td>
                                                                            <td>4</td>
                                                                            <td class="pr-2">10,000</td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td class="pl-2">プラチナ</td>
                                                                            <td>130cm</td>
                                                                            <td>aa-002</td>
                                                                            <td>8</td>
                                                                            <td class="pr-2">10,000</td>
                                                                        </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button class="btn btn-ec-sub" type="button"
                                                                            data-dismiss="modal">戻る
                                                                    </button>
                                                                    <a class="btn btn-ec-conversion"
                                                                       href="/product/register/standard">規格の編集</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    {# 規格なし商品 は在庫数を表示 #}
                                                    {% if Product.stockunlimited_min %}
                                                        無制限
                                                    {% else %}
                                                        {{ Product.stock_min }}
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td class="align-middle">
                                                {{ Product.status.name }}
                                            </td>
                                            <td class="align-middle">
                                                {{ Product.create_date|date_format }}
                                            </td>
                                            <td class="align-middle">
                                                {{ Product.update_date|date_format }}
                                            </td>
                                            <td class="align-middle pr-3" colspan="3">
                                                <div class="row">
                                                    <div class="col text-center" data-toggle="tooltip"
                                                         data-placement="top"
                                                         title="表示"><a class="btn btn-ec-actionIcon"
                                                                       href="{{ url('product_detail', {id:Product.id}) }}"
                                                                       target="_blank"><i
                                                                    class="fa fa-eye fa-lg text-secondary"
                                                                    aria-hidden="true"></i></a></div>
                                                    <div class="col text-center" data-toggle="tooltip"
                                                         data-placement="top"
                                                         title="複製"><a class="btn btn-ec-actionIcon"
                                                                       href="{{ url('admin_product_product_copy', {'id' : Product.id}) }}" {{ csrf_token_for_anchor() }}
                                                                       data-method="post"
                                                                       data-message="商品情報を複製してもよろしいですか？"><i
                                                                    class="fa fa-files-o fa-lg text-secondary"
                                                                    aria-hidden="true"></i></a></div>
                                                    <div class="col text-center" data-toggle="tooltip"
                                                         data-placement="top"
                                                         title="廃止"><a class="btn btn-ec-actionIcon" data-toggle="modal"
                                                                       data-target="#discontinuance"><i
                                                                    class="fa fa-close fa-lg text-secondary"
                                                                    aria-hidden="true"></i></a>
                                                        <div class="modal fade" id="discontinuance" tabindex="-1"
                                                             role="dialog"
                                                             aria-labelledby="discontinuance" aria-hidden="true">
                                                            <div class="modal-dialog" role="document">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <h5 class="modal-title font-weight-bold">
                                                                            商品の取扱を停止します</h5>
                                                                        <button class="close" type="button"
                                                                                data-dismiss="modal"
                                                                                aria-label="Close"><span
                                                                                    aria-hidden="true">×</span>
                                                                        </button>
                                                                    </div>
                                                                    <div class="modal-body text-left">
                                                                        <p class="text-left">
                                                                            商品は一覧（マスター）から削除されますが、これまでの取引等のデータから消えることはありません。この操作はあとから取り消すことができません。この商品を廃止しますか？</p>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button class="btn btn-ec-sub" type="button"
                                                                                data-dismiss="modal">キャンセル
                                                                        </button>
                                                                        {# TODO: 削除のアラートを出さないようにする #}
                                                                        <a href="{{ url('admin_product_product_delete', {'id' : Product.id}) }}" {{ csrf_token_for_anchor() }}
                                                                           data-method="delete"
                                                                           data-message="商品情報を削除してもよろしいですか？">削除</a>
                                                                        <button class="btn btn-ec-delete" type="button">
                                                                            取扱を停止
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    </tbody>
                                </table>
                            </div>
                            <div class="row justify-content-md-center mb-4">
                                {% if pagination.totalItemCount > 0 %}
                                    {% include "@admin/styleguide_pager.twig" with { 'pages' : pagination.paginationData, 'routes' : 'admin_product_page' } %}
                                {% endif %}
                            </div>
                        </div>

                    {% else %}
                        <div class="card rounded border-0">
                            <div class="card-body p-4">
                                <div class="text-center text-muted mb-4 h5">検索条件に合致するデータが見つかりませんでした</div>
                                <div class="text-center text-muted">検索条件を変えて、再度検索をお試しください。</div>
                                <div class="text-center text-muted">[詳細検索]も試してみましょう。</div>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="card rounded border-0">
                        <div class="card-body p-4">
                            <div class="text-center text-muted mb-2 h5">現在データが登録されていません。登録してみましょう！</div>
                            <div class="text-center mb-4"><a class="btn btn-ec-regular pl-4 pr-4"
                                                             href="{{ url('admin_product_product_new') }}">新規登録</a>
                            </div>
                            <div class="text-center text-muted">データが消えてしまいましたか？バックアップをしているならリストアを試してみましょう。</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>


{% endblock %}
